<!DOCTYPE html>
<html>
	<head>
		<title>Simple Map</title>
		<meta name="viewport" content="initial-scale=1.0">
		<meta charset="utf-8">
		<style>
			html, body {
				height: 100%;
				margin: 0;
				padding: 0;
			}
			#map {
				height: 100%;
			}
			#legend {
				background: white;
				padding: 10px;
				margin: 10px;
			}
		</style>
	</head>
	<body>
		<div id="map"></div>
		<div id="legend"><input type="text" id="counter" style="width:20px"/><br/><a href="javascript:loadpath();">load</a></div>
		<script>

			var map;

			function initMap() {
				map = new google.maps.Map(document.getElementById('map'), {
					center: {lat: 51.065338, lng: 13.751926},
					zoom: 18
				});
				map.controls[google.maps.ControlPosition.RIGHT_TOP].push(document.getElementById('legend'));
			};



		</script>
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXdi6bYauELE7KdjlavIX5_Ezc8fdppVc&callback=initMap" async defer></script>

		<script src="/socket.io/socket.io.js"></script>
		<script>
			var socket = io();

			var lastlon;
			var lastlat;
			var globmarker=true;
			
			function loadpath()
			{
				lastlon=null;
				lastlat=null;
				//globmarker=false;
				var count = parseInt(document.getElementById('counter').value);
				socket.emit('load',count);
			};

			socket.on('pos', function(msg){
			
				if(map)
				{
					var myLatlng = new google.maps.LatLng(msg.lon,msg.lat);
					map.panTo(myLatlng);
		
					if(globmarker)
					{	

						var marker = new google.maps.Marker({
							position: myLatlng,
							map: map,
							title: ''
						});


						if(msg.speed > 0)
						{
							marker.setIcon({
								path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
								scale: 1,
								rotation: parseInt(msg.head,10)
							});
						};

						var infowindow = new google.maps.InfoWindow({
							content: msg.info
						});
						
						marker.addListener('click', function() {
							infowindow.open(map, marker);
						});
					};

					if((lastlon)&&(lastlon != msg.lon)&&(lastlat != msg.lat))
					{
							var myLatlng2 = new google.maps.LatLng(lastlon,lastlat);

							var coordinates = [myLatlng2,myLatlng];

							var color = '#FF0000';

							if(msg.speed > 4 )
							{
								color = '#FF00FF';
							}
							if(msg.speed > 20 )
							{
								color = '#0000FF';
							}

							var path = new google.maps.Polyline({
												path: coordinates,
												geodesic: true,
												strokeColor: color,
												strokeOpacity: 1.0,
												strokeWeight: 2
							});
							path.setMap(map);
					}



					lastlon=msg.lon;
					lastlat=msg.lat;
				}
			});
		</script>
	</body>
</html>
